# synchronized ä»£ç å—è¯¦è§£

## ğŸ¯ æ ¸å¿ƒé—®é¢˜

**ä»€ä¹ˆæ˜¯ synchronized ä»£ç å—ï¼Ÿ**
- synchronized ä»£ç å—æ˜¯ Java æä¾›çš„åŒæ­¥æœºåˆ¶
- ç”¨äºä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œä»£ç å—ä¸­çš„ä»£ç 
- æ˜¯å®ç°çº¿ç¨‹å®‰å…¨çš„é‡è¦æ‰‹æ®µ

**å¹²ä»€ä¹ˆçš„ï¼Ÿ**
- è§£å†³å¤šçº¿ç¨‹å¹¶å‘è®¿é—®å…±äº«èµ„æºæ—¶çš„çº¿ç¨‹å®‰å…¨é—®é¢˜
- é˜²æ­¢ç«æ€æ¡ä»¶ï¼ˆRace Conditionï¼‰
- ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œæ­£ç¡®æ€§

**æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ**
- âœ… ä¿è¯åŸå­æ€§ï¼šä»£ç å—å†…çš„æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œ
- âœ… ä¿è¯å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹çš„ä¿®æ”¹å¯¹å…¶ä»–çº¿ç¨‹å¯è§
- âœ… ä¿è¯æœ‰åºæ€§ï¼šç¦æ­¢æŒ‡ä»¤é‡æ’åº

---

## ğŸ“Š åŸºæœ¬è¯­æ³•

### è¯­æ³•æ ¼å¼

```java
synchronized (é”å¯¹è±¡) {
    // éœ€è¦åŒæ­¥çš„ä»£ç 
}
```

**å…³é”®è¦ç´ ï¼š**
- **é”å¯¹è±¡**ï¼šå¯ä»¥æ˜¯ä»»æ„å¯¹è±¡ï¼Œä½œä¸ºé”çš„æ ‡è¯†
- **ä»£ç å—**ï¼šéœ€è¦åŒæ­¥æ‰§è¡Œçš„ä»£ç 

---

## ğŸ’¡ ä¸‰ç§ä½¿ç”¨æ–¹å¼

### æ–¹å¼1ï¼šsynchronized ä»£ç å—ï¼ˆé”æŒ‡å®šå¯¹è±¡ï¼‰

```java
Object lock = new Object();

public void method() {
    synchronized (lock) {
        // éœ€è¦åŒæ­¥çš„ä»£ç 
        count++;
    }
}
```

**ç‰¹ç‚¹ï¼š**
- é”çš„æ˜¯æŒ‡å®šçš„å¯¹è±¡ï¼ˆ`lock`ï¼‰
- å¤šä¸ªæ–¹æ³•å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªé”å¯¹è±¡å®ç°åŒæ­¥
- æ›´çµæ´»ï¼Œå¯ä»¥é€‰æ‹©é”çš„ç²’åº¦

---

### æ–¹å¼2ï¼šsynchronized æ–¹æ³•ï¼ˆé”å½“å‰å¯¹è±¡ thisï¼‰

```java
public synchronized void method() {
    // éœ€è¦åŒæ­¥çš„ä»£ç 
    count++;
}
```

**ç­‰ä»·äºï¼š**
```java
public void method() {
    synchronized (this) {
        // éœ€è¦åŒæ­¥çš„ä»£ç 
        count++;
    }
}
```

**ç‰¹ç‚¹ï¼š**
- é”çš„æ˜¯å½“å‰å¯¹è±¡ï¼ˆ`this`ï¼‰
- åŒä¸€ä¸ªå¯¹è±¡çš„åŒæ­¥æ–¹æ³•ä¼šäº’ç›¸é˜»å¡
- ä¸åŒå¯¹è±¡çš„åŒæ­¥æ–¹æ³•ä¸ä¼šäº’ç›¸å½±å“

---

### æ–¹å¼3ï¼šsynchronized é™æ€æ–¹æ³•ï¼ˆé”ç±»å¯¹è±¡ï¼‰

```java
public static synchronized void method() {
    // éœ€è¦åŒæ­¥çš„ä»£ç 
}
```

**ç­‰ä»·äºï¼š**
```java
public static void method() {
    synchronized (ClassName.class) {
        // éœ€è¦åŒæ­¥çš„ä»£ç 
    }
}
```

**ç‰¹ç‚¹ï¼š**
- é”çš„æ˜¯ç±»å¯¹è±¡ï¼ˆ`ClassName.class`ï¼‰
- æ‰€æœ‰å®ä¾‹çš„é™æ€åŒæ­¥æ–¹æ³•å…±äº«åŒä¸€æŠŠé”
- ç±»çº§åˆ«çš„åŒæ­¥

---

## ğŸ” è¯¦ç»†å¯¹æ¯”

### åŒæ­¥ä»£ç å— vs åŒæ­¥æ–¹æ³•

| ç‰¹æ€§ | synchronized ä»£ç å— | synchronized æ–¹æ³• |
|------|-------------------|------------------|
| **é”çš„å¯¹è±¡** | æŒ‡å®šå¯¹è±¡ | `this`ï¼ˆå½“å‰å¯¹è±¡ï¼‰ |
| **çµæ´»æ€§** | â­â­â­â­â­ é«˜ | â­â­â­ ä¸­ |
| **ç²’åº¦æ§åˆ¶** | âœ… å¯ä»¥ç²¾ç¡®æ§åˆ¶ | âŒ æ•´ä¸ªæ–¹æ³•éƒ½åŒæ­¥ |
| **æ€§èƒ½** | â­â­â­â­ å¥½ï¼ˆç²’åº¦å°ï¼‰ | â­â­â­ ä¸€èˆ¬ |
| **ä½¿ç”¨åœºæ™¯** | éœ€è¦éƒ¨åˆ†ä»£ç åŒæ­¥ | æ•´ä¸ªæ–¹æ³•éƒ½éœ€è¦åŒæ­¥ |

---

## ğŸ’¡ ä¸ºä»€ä¹ˆéœ€è¦ synchronized ä»£ç å—ï¼Ÿ

### é—®é¢˜æ¼”ç¤ºï¼šæ²¡æœ‰åŒæ­¥çš„æƒ…å†µ

```java
public class Counter {
    private int count = 0;
    
    public void increment() {
        count++;  // âŒ ä¸æ˜¯åŸå­æ“ä½œ
    }
    
    public int getCount() {
        return count;
    }
}

// å¤šçº¿ç¨‹è®¿é—®
Counter counter = new Counter();
Thread t1 = new Thread(() -> {
    for (int i = 0; i < 10000; i++) {
        counter.increment();
    }
});

Thread t2 = new Thread(() -> {
    for (int i = 0; i < 10000; i++) {
        counter.increment();
    }
});

t1.start();
t2.start();
t1.join();
t2.join();

System.out.println(counter.getCount());  // âŒ å¯èƒ½å°äº 20000
```

**é—®é¢˜åˆ†æï¼š**
- `count++` ä¸æ˜¯åŸå­æ“ä½œ
- åŒ…å«ä¸‰ä¸ªæ­¥éª¤ï¼šè¯»å– â†’ åŠ 1 â†’ å†™å›
- ä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶è¯»å–åˆ°ç›¸åŒçš„å€¼ï¼Œå¯¼è‡´æ›´æ–°ä¸¢å¤±

---

### è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ synchronized ä»£ç å—

```java
public class Counter {
    private int count = 0;
    private final Object lock = new Object();  // é”å¯¹è±¡
    
    public void increment() {
        synchronized (lock) {  // âœ… ä½¿ç”¨ä»£ç å—åŒæ­¥
            count++;  // ç°åœ¨æ˜¯åŸå­æ“ä½œ
        }
    }
    
    public int getCount() {
        synchronized (lock) {  // âœ… è¯»å–ä¹Ÿè¦åŒæ­¥
            return count;
        }
    }
}
```

**æ•ˆæœï¼š**
- âœ… ä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æ‰§è¡Œ `count++`
- âœ… ä¿è¯ `getCount()` è¯»å–åˆ°çš„æ˜¯æœ€æ–°å€¼
- âœ… æ•°æ®ä¸ä¼šä¸¢å¤±

---

## ğŸ¯ æ ¸å¿ƒä½œç”¨

### 1. ä¿è¯åŸå­æ€§ï¼ˆAtomicityï¼‰

**åŸå­æ€§ï¼š** ä¸€ä¸ªæ“ä½œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œ

**ç¤ºä¾‹ï¼š**
```java
// âŒ æ²¡æœ‰åŒæ­¥ï¼šä¸æ˜¯åŸå­æ“ä½œ
count++;  // åŒ…å«ï¼šè¯»å– â†’ åŠ 1 â†’ å†™å›

// âœ… æœ‰åŒæ­¥ï¼šä¿è¯åŸå­æ€§
synchronized (lock) {
    count++;  // è¿™ä¸‰ä¸ªæ­¥éª¤ä½œä¸ºä¸€ä¸ªæ•´ä½“æ‰§è¡Œ
}
```

**åŸç†ï¼š**
- synchronized ä»£ç å—è·å–é”åï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…
- ä»£ç å—æ‰§è¡Œå®Œæˆåé‡Šæ”¾é”ï¼Œå…¶ä»–çº¿ç¨‹æ‰èƒ½ç»§ç»­
- ä¿è¯äº†æ“ä½œçš„åŸå­æ€§

---

### 2. ä¿è¯å¯è§æ€§ï¼ˆVisibilityï¼‰

**å¯è§æ€§ï¼š** ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°ä¿®æ”¹

**ç¤ºä¾‹ï¼š**
```java
private boolean flag = false;  // å…±äº«å˜é‡

// çº¿ç¨‹1ï¼šä¿®æ”¹ flag
Thread t1 = new Thread(() -> {
    synchronized (lock) {
        flag = true;  // âœ… ä¿®æ”¹åï¼Œå…¶ä»–çº¿ç¨‹èƒ½çœ‹åˆ°
    }
});

// çº¿ç¨‹2ï¼šè¯»å– flag
Thread t2 = new Thread(() -> {
    synchronized (lock) {
        if (flag) {  // âœ… èƒ½çœ‹åˆ°çº¿ç¨‹1çš„ä¿®æ”¹
            // æ‰§è¡Œæ“ä½œ
        }
    }
});
```

**åŸç†ï¼š**
- synchronized ä»£ç å—é‡Šæ”¾é”æ—¶ä¼šå¼ºåˆ¶å°†ä¿®æ”¹åˆ·æ–°åˆ°ä¸»å†…å­˜
- synchronized ä»£ç å—è·å–é”æ—¶ä¼šä»ä¸»å†…å­˜è¯»å–æœ€æ–°å€¼
- ä¿è¯äº†å¯è§æ€§

---

### 3. ä¿è¯æœ‰åºæ€§ï¼ˆOrderingï¼‰

**æœ‰åºæ€§ï¼š** ç¨‹åºæ‰§è¡ŒæŒ‰ç…§ä»£ç çš„é¡ºåºæ‰§è¡Œ

**ç¤ºä¾‹ï¼š**
```java
int x = 0;
boolean flag = false;

// çº¿ç¨‹1
synchronized (lock) {
    x = 1;        // æ“ä½œ1
    flag = true;  // æ“ä½œ2
    // synchronized ä¿è¯æ“ä½œ1åœ¨æ“ä½œ2ä¹‹å‰æ‰§è¡Œ
}

// çº¿ç¨‹2
synchronized (lock) {
    if (flag) {
        // ä¿è¯çœ‹åˆ° flag = true æ—¶ï¼Œx ä¸€å®šæ˜¯ 1
        System.out.println(x);  // ä¸€å®šæ˜¯ 1
    }
}
```

**åŸç†ï¼š**
- synchronized ä»£ç å—å†…éƒ¨ç¦æ­¢æŒ‡ä»¤é‡æ’åº
- ä¿è¯ä»£ç çš„æ‰§è¡Œé¡ºåºç¬¦åˆé¢„æœŸ

---

## ğŸ” æ·±å…¥ç†è§£

### synchronized çš„å·¥ä½œåŸç†

#### 1. å¯¹è±¡é”ï¼ˆMonitorï¼‰

æ¯ä¸ª Java å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªå†…ç½®çš„ç›‘è§†å™¨é”ï¼ˆMonitor Lockï¼‰

```java
Object obj = new Object();

synchronized (obj) {
    // è·å– obj çš„ç›‘è§†å™¨é”
    // æ‰§è¡Œä»£ç 
    // é‡Šæ”¾ obj çš„ç›‘è§†å™¨é”
}
```

**å…³é”®ç‚¹ï¼š**
- æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªé”
- åªæœ‰è·å–åˆ°é”çš„çº¿ç¨‹æ‰èƒ½æ‰§è¡Œä»£ç å—
- å…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…é”è¢«é‡Šæ”¾

---

#### 2. é”çš„è·å–å’Œé‡Šæ”¾

**è·å–é”ï¼š**
- çº¿ç¨‹å°è¯•è·å–é”
- å¦‚æœé”å·²è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰ï¼Œå½“å‰çº¿ç¨‹è¿›å…¥ BLOCKED çŠ¶æ€
- ç­‰å¾…é”è¢«é‡Šæ”¾

**é‡Šæ”¾é”ï¼š**
- ä»£ç å—æ‰§è¡Œå®Œæˆ
- æ­£å¸¸é€€å‡ºæˆ–æŠ›å‡ºå¼‚å¸¸éƒ½ä¼šé‡Šæ”¾é”
- ç­‰å¾…çš„çº¿ç¨‹å¯ä»¥ç«äº‰è·å–é”

**ç¤ºä¾‹ï¼š**
```java
Object lock = new Object();

Thread t1 = new Thread(() -> {
    synchronized (lock) {
        System.out.println("Thread-1 è·å–åˆ°é”");
        try {
            Thread.sleep(5000);  // æŒæœ‰é” 5 ç§’
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
        System.out.println("Thread-1 é‡Šæ”¾é”");
    }
});

Thread t2 = new Thread(() -> {
    System.out.println("Thread-2 å°è¯•è·å–é”");
    synchronized (lock) {  // ç­‰å¾… t1 é‡Šæ”¾é”
        System.out.println("Thread-2 è·å–åˆ°é”");
    }
});

t1.start();
Thread.sleep(100);
t2.start();

// è¾“å‡ºï¼š
// Thread-1 è·å–åˆ°é”
// Thread-2 å°è¯•è·å–é”
// ï¼ˆç­‰å¾… 5 ç§’ï¼‰
// Thread-1 é‡Šæ”¾é”
// Thread-2 è·å–åˆ°é”
```

---

### 3. å¯é‡å…¥æ€§ï¼ˆReentrantï¼‰

**å¯é‡å…¥æ€§ï¼š** åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–åŒä¸€ä¸ªé”

**ç¤ºä¾‹ï¼š**
```java
public class ReentrantDemo {
    private final Object lock = new Object();
    
    public void method1() {
        synchronized (lock) {
            System.out.println("method1 è·å–é”");
            method2();  // âœ… å¯ä»¥è°ƒç”¨å¦ä¸€ä¸ªåŒæ­¥æ–¹æ³•
            System.out.println("method1 é‡Šæ”¾é”");
        }
    }
    
    public void method2() {
        synchronized (lock) {
            System.out.println("method2 è·å–é”ï¼ˆé‡å…¥ï¼‰");
            // æ‰§è¡Œä»£ç 
        }
    }
}

// ä½¿ç”¨
ReentrantDemo demo = new ReentrantDemo();
demo.method1();

// è¾“å‡ºï¼š
// method1 è·å–é”
// method2 è·å–é”ï¼ˆé‡å…¥ï¼‰âœ… åŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥å†æ¬¡è·å–é”
// method2 é‡Šæ”¾é”
// method1 é‡Šæ”¾é”
```

**ä¸ºä»€ä¹ˆéœ€è¦å¯é‡å…¥ï¼Ÿ**
- é¿å…æ­»é”ï¼šå¦‚æœä¸å¯é‡å…¥ï¼Œmethod1 è°ƒç”¨ method2 ä¼šå¯¼è‡´æ­»é”
- æ–¹ä¾¿ç¼–ç¨‹ï¼šå¯ä»¥åœ¨åŒæ­¥æ–¹æ³•ä¸­è°ƒç”¨å…¶ä»–åŒæ­¥æ–¹æ³•

---

## ğŸ“‹ å®é™…åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šçº¿ç¨‹å®‰å…¨çš„è®¡æ•°å™¨

```java
public class SafeCounter {
    private int count = 0;
    private final Object lock = new Object();
    
    public void increment() {
        synchronized (lock) {
            count++;  // âœ… åŸå­æ“ä½œ
        }
    }
    
    public int getCount() {
        synchronized (lock) {
            return count;  // âœ… è¯»å–æœ€æ–°å€¼
        }
    }
}
```

---

### åœºæ™¯2ï¼šçº¿ç¨‹å®‰å…¨çš„é›†åˆæ“ä½œ

```java
public class SafeList {
    private List<String> list = new ArrayList<>();
    private final Object lock = new Object();
    
    public void add(String item) {
        synchronized (lock) {
            list.add(item);  // âœ… çº¿ç¨‹å®‰å…¨
        }
    }
    
    public void remove(String item) {
        synchronized (lock) {
            list.remove(item);  // âœ… çº¿ç¨‹å®‰å…¨
        }
    }
    
    public List<String> getAll() {
        synchronized (lock) {
            return new ArrayList<>(list);  // âœ… è¿”å›å‰¯æœ¬ï¼Œé¿å…å¤–éƒ¨ä¿®æ”¹
        }
    }
}
```

---

### åœºæ™¯3ï¼šç»†ç²’åº¦é”æ§åˆ¶

```java
public class FineGrainedLock {
    private int count1 = 0;
    private int count2 = 0;
    private final Object lock1 = new Object();
    private final Object lock2 = new Object();
    
    // ä½¿ç”¨ä¸åŒçš„é”ï¼Œæé«˜å¹¶å‘æ€§èƒ½
    public void increment1() {
        synchronized (lock1) {  // åªé” count1
            count1++;
        }
    }
    
    public void increment2() {
        synchronized (lock2) {  // åªé” count2
            count2++;
        }
    }
    
    // count1 å’Œ count2 å¯ä»¥å¹¶å‘ä¿®æ”¹ï¼Œä¸äº’ç›¸é˜»å¡
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… æé«˜å¹¶å‘æ€§èƒ½
- âœ… å‡å°‘é”ç«äº‰
- âœ… æ›´ç»†ç²’åº¦çš„æ§åˆ¶

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. é”å¯¹è±¡çš„é€‰æ‹©

**é—®é¢˜ï¼š** é€‰æ‹©é”™è¯¯çš„é”å¯¹è±¡å¯èƒ½å¯¼è‡´åŒæ­¥å¤±æ•ˆ

```java
// âŒ é”™è¯¯ï¼šæ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡
public void method() {
    Object lock = new Object();  // æ¯æ¬¡éƒ½æ˜¯æ–°å¯¹è±¡
    synchronized (lock) {
        // åŒæ­¥å¤±æ•ˆï¼æ¯ä¸ªçº¿ç¨‹çš„ lock éƒ½æ˜¯ä¸åŒçš„
    }
}

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å…±äº«çš„é”å¯¹è±¡
private final Object lock = new Object();  // æˆå‘˜å˜é‡ï¼Œæ‰€æœ‰çº¿ç¨‹å…±äº«

public void method() {
    synchronized (lock) {
        // æ‰€æœ‰çº¿ç¨‹ä½¿ç”¨åŒä¸€ä¸ªé”å¯¹è±¡
    }
}
```

---

### 2. é”çš„èŒƒå›´ï¼ˆç²’åº¦ï¼‰

**ç²—ç²’åº¦é”ï¼š**
```java
// âŒ é”çš„èŒƒå›´å¤ªå¤§
synchronized (lock) {
    // å¤§é‡ä»£ç 
    doSomething1();
    doSomething2();
    doSomething3();
    // åªæœ‰éƒ¨åˆ†ä»£ç éœ€è¦åŒæ­¥ï¼Œä½†æ•´ä¸ªä»£ç å—éƒ½è¢«é”ä½
}
```

**ç»†ç²’åº¦é”ï¼š**
```java
// âœ… åªé”éœ€è¦åŒæ­¥çš„éƒ¨åˆ†
doSomething1();  // ä¸éœ€è¦åŒæ­¥

synchronized (lock) {
    // åªé”éœ€è¦åŒæ­¥çš„ä»£ç 
    doSomething2();
}

doSomething3();  // ä¸éœ€è¦åŒæ­¥
```

**åŸåˆ™ï¼š** å°½é‡å‡å°é”çš„èŒƒå›´ï¼Œæé«˜å¹¶å‘æ€§èƒ½

---

### 3. æ­»é”é—®é¢˜

**é—®é¢˜ï¼š** å¤šä¸ªçº¿ç¨‹äº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”

```java
// âŒ å¯èƒ½å¯¼è‡´æ­»é”
Object lock1 = new Object();
Object lock2 = new Object();

Thread t1 = new Thread(() -> {
    synchronized (lock1) {
        synchronized (lock2) {  // ç­‰å¾… lock2
            // æ‰§è¡Œä»£ç 
        }
    }
});

Thread t2 = new Thread(() -> {
    synchronized (lock2) {
        synchronized (lock1) {  // ç­‰å¾… lock1
            // æ‰§è¡Œä»£ç 
        }
    }
});

// t1 æŒæœ‰ lock1ï¼Œç­‰å¾… lock2
// t2 æŒæœ‰ lock2ï¼Œç­‰å¾… lock1
// æ­»é”ï¼
```

**è§£å†³æ–¹æ¡ˆï¼š**
- âœ… æŒ‰ç…§ç›¸åŒé¡ºåºè·å–é”
- âœ… ä½¿ç”¨è¶…æ—¶æœºåˆ¶
- âœ… é¿å…åµŒå¥—é”

---

### 4. æ€§èƒ½è€ƒè™‘

**synchronized çš„æ€§èƒ½å¼€é”€ï¼š**
- è·å–é”å’Œé‡Šæ”¾é”æœ‰æ€§èƒ½å¼€é”€
- çº¿ç¨‹é˜»å¡å’Œå”¤é†’æœ‰æ€§èƒ½å¼€é”€
- ä¸²è¡Œæ‰§è¡Œé™ä½å¹¶å‘æ€§èƒ½

**ä¼˜åŒ–å»ºè®®ï¼š**
- âœ… å‡å°é”çš„èŒƒå›´
- âœ… ä½¿ç”¨ç»†ç²’åº¦é”
- âœ… é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨ synchronized
- âœ… è€ƒè™‘ä½¿ç”¨ `java.util.concurrent` åŒ…çš„å¹¶å‘å·¥å…·

---

## ğŸ”„ synchronized ä»£ç å— vs synchronized æ–¹æ³•

### å¯¹æ¯”ç¤ºä¾‹

#### ä½¿ç”¨ synchronized æ–¹æ³•

```java
public class Counter {
    private int count = 0;
    
    // æ•´ä¸ªæ–¹æ³•éƒ½åŒæ­¥
    public synchronized void increment() {
        count++;
        // å…¶ä»–ä¸éœ€è¦åŒæ­¥çš„æ“ä½œä¹Ÿè¢«é”ä½äº†
        log.info("Count: " + count);
    }
}
```

**é—®é¢˜ï¼š**
- æ•´ä¸ªæ–¹æ³•éƒ½åŒæ­¥ï¼Œç²’åº¦å¤ªç²—
- ä¸éœ€è¦åŒæ­¥çš„æ“ä½œä¹Ÿè¢«é”ä½

#### ä½¿ç”¨ synchronized ä»£ç å—

```java
public class Counter {
    private int count = 0;
    private final Object lock = new Object();
    
    // åªé”éœ€è¦åŒæ­¥çš„éƒ¨åˆ†
    public void increment() {
        synchronized (lock) {
            count++;  // åªåŒæ­¥è¿™éƒ¨åˆ†
        }
        log.info("Count: " + count);  // ä¸éœ€è¦åŒæ­¥ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œ
    }
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ç²’åº¦æ›´ç»†ï¼Œæ€§èƒ½æ›´å¥½
- âœ… çµæ´»æ€§æ›´é«˜

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„é”å¯¹è±¡

```java
// âœ… æ¨èï¼šä½¿ç”¨ä¸“é—¨çš„é”å¯¹è±¡
private final Object lock = new Object();

// âš ï¸ ä¸æ¨èï¼šä½¿ç”¨ thisï¼ˆå¯èƒ½è¢«å¤–éƒ¨è·å–ï¼‰
synchronized (this) { ... }

// âš ï¸ ä¸æ¨èï¼šä½¿ç”¨å­—ç¬¦ä¸²å¸¸é‡ï¼ˆå¯èƒ½ä¸å…¶ä»–ç±»å†²çªï¼‰
synchronized ("lock") { ... }
```

---

### 2. å‡å°é”çš„èŒƒå›´

```java
// âŒ ä¸æ¨èï¼šé”çš„èŒƒå›´å¤ªå¤§
public void method() {
    synchronized (lock) {
        // å¤§é‡ä¸éœ€è¦åŒæ­¥çš„ä»£ç 
        doSomething1();
        doSomething2();
        // åªæœ‰è¿™ä¸€è¡Œéœ€è¦åŒæ­¥
        count++;
        doSomething3();
        doSomething4();
    }
}

// âœ… æ¨èï¼šåªé”éœ€è¦åŒæ­¥çš„éƒ¨åˆ†
public void method() {
    doSomething1();
    doSomething2();
    synchronized (lock) {
        count++;  // åªé”è¿™ä¸€è¡Œ
    }
    doSomething3();
    doSomething4();
}
```

---

### 3. é¿å…åœ¨å¾ªç¯ä¸­ä½¿ç”¨ synchronized

```java
// âŒ ä¸æ¨èï¼šæ¯æ¬¡å¾ªç¯éƒ½è·å–é”
for (int i = 0; i < 1000; i++) {
    synchronized (lock) {
        count++;
    }
}

// âœ… æ¨èï¼šåœ¨å¾ªç¯å¤–è·å–é”
synchronized (lock) {
    for (int i = 0; i < 1000; i++) {
        count++;
    }
}
```

---

### 4. ä½¿ç”¨ final ä¿®é¥°é”å¯¹è±¡

```java
// âœ… æ¨èï¼šä½¿ç”¨ finalï¼Œé˜²æ­¢é”å¯¹è±¡è¢«ä¿®æ”¹
private final Object lock = new Object();

// âŒ ä¸æ¨èï¼šé”å¯¹è±¡å¯èƒ½è¢«ä¿®æ”¹
private Object lock = new Object();
lock = new Object();  // é”å¯¹è±¡æ”¹å˜ï¼ŒåŒæ­¥å¤±æ•ˆ
```

---

## ğŸ“ æ€»ç»“

### synchronized ä»£ç å—çš„æ ¸å¿ƒè¦ç‚¹

1. **ä½œç”¨**
   - ä¿è¯åŸå­æ€§ã€å¯è§æ€§ã€æœ‰åºæ€§
   - å®ç°çº¿ç¨‹å®‰å…¨
   - é˜²æ­¢ç«æ€æ¡ä»¶

2. **è¯­æ³•**
   ```java
   synchronized (é”å¯¹è±¡) {
       // éœ€è¦åŒæ­¥çš„ä»£ç 
   }
   ```

3. **åŸç†**
   - åŸºäºå¯¹è±¡ç›‘è§†å™¨é”ï¼ˆMonitorï¼‰
   - åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½è·å–é”
   - å…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…

4. **ä¼˜åŠ¿**
   - ç²’åº¦æ§åˆ¶çµæ´»
   - å¯ä»¥é€‰æ‹©é”å¯¹è±¡
   - æ€§èƒ½ç›¸å¯¹è¾ƒå¥½

5. **æ³¨æ„äº‹é¡¹**
   - é€‰æ‹©åˆé€‚çš„é”å¯¹è±¡
   - å‡å°é”çš„èŒƒå›´
   - é¿å…æ­»é”
   - æ³¨æ„æ€§èƒ½å½±å“

### è®°å¿†è¦ç‚¹

> **synchronized ä»£ç å— = é” + ä»£ç **
> 
> - é”ï¼šä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ
> - ä»£ç ï¼šéœ€è¦åŒæ­¥çš„éƒ¨åˆ†
> - ä½œç”¨ï¼šä¿è¯çº¿ç¨‹å®‰å…¨

### ä¸ synchronized æ–¹æ³•çš„å…³ç³»

- **synchronized æ–¹æ³•** æ˜¯ **synchronized ä»£ç å—** çš„ç®€åŒ–å½¢å¼
- **synchronized æ–¹æ³•** é”çš„æ˜¯ `this`
- **synchronized ä»£ç å—** æ›´çµæ´»ï¼Œå¯ä»¥é€‰æ‹©é”å¯¹è±¡

---

## ğŸ¯ å­¦ä¹ æ£€éªŒ

å®Œæˆå­¦ä¹ åï¼Œä½ åº”è¯¥èƒ½å¤Ÿï¼š

- âœ… ç†è§£ synchronized ä»£ç å—çš„ä½œç”¨å’ŒåŸç†
- âœ… æŒæ¡ synchronized ä»£ç å—çš„è¯­æ³•
- âœ… çŸ¥é“å¦‚ä½•é€‰æ‹©åˆé€‚çš„é”å¯¹è±¡
- âœ… ç†è§£é”çš„ç²’åº¦å¯¹æ€§èƒ½çš„å½±å“
- âœ… èƒ½å¤Ÿä½¿ç”¨ synchronized ä»£ç å—è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜
- âœ… é¿å…å¸¸è§çš„é”™è¯¯ï¼ˆæ­»é”ã€åŒæ­¥å¤±æ•ˆç­‰ï¼‰

